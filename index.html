<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Генератор приглашений — Ключи Форта</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: url('background.jpg') center/cover no-repeat fixed;
    }

    header {
      background: #6c482e;
      color: #fff;
      padding: 14px 24px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
    }
    header .title { font-family: 'Cinzel', serif; }
    header img { height: 80px; justify-self: center; }

    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 24px;
      background: rgba(227, 217, 207, 0.95);
      border-radius: 14px;

      

      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .container_block{
      display: flex;
      
      justify-content: space-between;
    }

    h1 {
      grid-column: 1 / -1;
      text-align: center;
      font-family: 'Cinzel', serif;
      font-size: 22px;
      margin: 0;
    }

    label { display: block; margin-top: 12px; font-weight: 600; }

    input, select, textarea {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #aaa;
      font-family: inherit;
    }

    textarea { min-height: 100px; }

    button {
      margin-top: 18px;
      padding: 14px;
      width: 100%;
      border-radius: 10px;
      border: none;
      background: #6c482e;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .preview-wrapper { display: flex; justify-content: center; }

    .card {
      width: 504px;
      height: 720px;  
      position: relative;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      font-family: 'Montserrat', sans-serif;
    }

    .field {
      position: absolute;
      left: 48px;
      right: 48px;
      text-align: center;
      font-weight: 600;
      opacity: 0;
    }

    .address-text {
      text-align: left;
      padding-left: 50px;
      text-indent: 215px;
      line-height: 1.8;
    }
    
    @media (max-width: 900px) {
      .container_block { 
        flex-direction: column; 
      }
      .card { transform: scale(0.85); }
    }
    @media (max-width: 400px) {
      .card{ width: 300px; }
    }
  </style>
</head>
<body>

<header>
  <div class="title">Квест-шоу</div>
  <img src="logo.png" alt="Ключи Форта">
  <div class="title" style="text-align:right">Ключи Форта</div>
</header>

<div class="container">
  <div>
    <h1>Создайте пригласительные на Квест-шоу «Форт Боярд»</h1>
    <p style="font-family: 'Cinzel', serif;">Создайте персональные пригласительные для каждого участника на День рождения или любой другой повод!</p>
  </div>
  <div class="container_block">
    <form id="form">
      <label>Вариант приглашения</label>
      <select id="type" required>
        <option value="">— выберите —</option>
        <option value="kid">ДР дети</option>
        <option value="adult">ДР взрослые</option>
        <option value="school">Выпускной 4/9/11</option>
        <option value="kindergarten">Выпускной детский сад</option>
        <option value="trip">Поход классом</option>
        <option value="corporate">Корпоратив</option>
      </select>
  
      <div id="dynamic-fields"></div>
  
      <label>Адрес</label>
      <select id="address" required>
        <option value="">— выберите —</option>
        <option value="г. Москва, Варшав- ское шоссе, д.95 к.1, ТК «Аэробус», 3-й этаж">
          г. Москва, Варшавское шоссе, д.95 к.1, ТК «Аэробус», 3-й этаж
        </option>
        <option value="__custom__">➕ Добавить новый адрес</option>
      </select>
  
      <input id="customAddress" placeholder="Введите новый адрес" style="display:none; margin-top:8px;">
  
      <label>Дата</label>
      <input type="date" id="date" required>
  
      <label>Время</label>
      <input type="time" id="time" required>
  
      <label>Имена гостей (каждое с новой строки)</label>
      <textarea id="names" required></textarea>
  
      <button type="button" id="download">Скачать</button>
    </form>
  
    <div class="preview-wrapper">
      <div class="card" id="card">
        <div class="field" id="invite"></div>
        <div class="field address-text" id="addressField"></div>
        <div class="field" id="dateField"></div>
        <div class="field" id="field1"></div>
        <div class="field" id="field2"></div>
        <div class="field" id="timeField"></div>
        <div class="field" id="eventNameField"></div>
      </div>
    </div>
  </div>
</div>

<script>

/** * 1. КОНФИГ ДЛЯ ПРЕВЬЮ (то, что мы видим на экране)
 */
const TEMPLATES = {
  kid: { bg: 'kid.png', invite: { top: 240, left: 185, size: 20 }, address: { top: 357, left: 20 }, date: { top: 420, left: 130 }, time: { top: 449, left: 230 } },
  adult: { bg: 'adult.png', invite: { top: 243, left: 185, size: 20 }, address: { top: 362, left: 20 }, date: { top: 425, left: 130 }, time: { top: 454, left: 230 } },
  school: { bg: 'school.png', invite: { top: 263, left: 37, size: 20 }, address: { top: 395, left: 20 }, date: { top: 460, left: 130  }, time: { top: 489, left: 230 }, field1: { top: 297, left: -50 }, field2: { top: 294, left: 345 } },
  kindergarten: { bg: 'kindergarten.png', invite: { top: 263, left: 37, size: 20 }, address: { top: 405, left: 20 }, date: { top: 470, left: 130  }, time: { top: 499, left: 230  }, field1: { top: 297, left: 300 }, field2: { top: 325, left: -140 } },
  trip: { bg: 'trip.png', invite: { top: 263, left: 37, size: 20 }, address: { top: 408, left: 15 }, date: { top: 471, left: 60  }, time: { top: 501, left: 130  }, field1: { top: 297, left: -50 }, field2: { top: 296, left: 350 } },
  corporate: { bg: 'corporate.png', invite: { top: 240, left: 40, size: 20 }, address: { top: 392, left: 15 }, date: { top: 455, left: 130 }, time: { top: 484, left: 230  }, eventName: { top: 306, left: 40 } }
};

/**
 * 2. КОНФИГ ДЛЯ СКАЧИВАНИЯ (ЗДЕСЬ НАСТРАИВАЙ ТЕКСТ ДЛЯ PDF)
 * Координаты x и y считаются от верхнего левого угла в пикселях оригинала.
 */
const EXPORT_CONFIG = {
    canvasWidth: 1000,   // Примерная ширина твоего PNG файла
    canvasHeight: 1428,  // Примерная высота твоего PNG файла
    kid: {
        invite:  { x: 600, y: 465, size: 40, align: 'center' },
        address: { x: 580, y: 720, size: 28, align: 'center' },
        date:    { x: 570, y: 840, size: 30, align: 'center' },
        time:    { x: 650, y: 900, size: 30, align: 'center' }
    },
    adult: {
        invite:  { x: 500, y: 480, size: 40, align: 'left' },
        address: { x: 580, y: 730, size: 28, align: 'left' },
        date:    { x: 520, y: 850, size: 30, align: 'left' },
        time:    { x: 650, y: 910, size: 30, align: 'left' }
    },
    // Добавь остальные типы по аналогии, когда проверишь эти
    school: {
  invite: { x: 500, y: 520, size: 35, align: 'center' },
  field1: { x: 400, y: 590, size: 28, align: 'center' }, // номер класса
  field2: { x: 795, y: 585, size: 28, align: 'center' }, // номер школы
  address: { x: 580, y: 805, size: 28, align: 'center' },
  date: { x: 550, y: 920, size: 30, align: 'center' },
  time: { x: 600, y: 980, size: 30, align: 'center' }
},
    kindergarten: {
  invite: { x: 500, y: 525 , size: 35, align: 'center' },
  field1: { x: 775, y: 590, size: 28, align: 'center' }, // номер класса
  field2: { x: 315, y: 650, size: 28, align: 'center' }, // номер школы
  address: { x: 575, y: 825, size: 28, align: 'center' },
  date: { x: 550, y: 945, size: 30, align: 'center' },
  time: { x: 630, y: 1005, size: 30, align: 'center' } 
},
  trip: { invite: { x: 500, y: 525, size: 35, align: 'center' },
  field1: { x: 400, y: 590, size: 28, align: 'center' }, // номер класса
  field2: { x: 795, y: 590, size: 28, align: 'center' }, // номер школы
  address: { x: 580, y: 830, size: 28, align: 'center' },
  date: { x: 490, y: 945, size: 30, align: 'center' },
  time: { x: 600, y: 1005, size: 30, align: 'center' }
},
    corporate: { 
      invite: { x: 500, y: 472, size: 40, align: 'center' }, 
      address: { x: 570, y: 797, size: 28, align: 'center' }, 
      date: { x: 530, y: 913, size: 30, align: 'center' }, 
      time: { x: 620, y: 970, size: 30, align: 'center' },
      eventName: {  x: 500, y: 600, size: 40, align: 'center' }  }
};

const typeEl = document.getElementById('type');
const dynamicFields = document.getElementById('dynamic-fields');
const card = document.getElementById('card');
const inviteEl = document.getElementById('invite');
const addressSelect = document.getElementById('address');
const customAddressInput = document.getElementById('customAddress');
const addressField = document.getElementById('addressField');
const dateField = document.getElementById('dateField');
const dateEl = document.getElementById('date');
const timeEl = document.getElementById('time');
const timeField = document.getElementById('timeField');
const namesEl = document.getElementById('names');
const field1 = document.getElementById('field1');
const field2 = document.getElementById('field2');
const eventNameField = document.getElementById('eventNameField');

const ADDRESS_STORAGE_KEY = 'fort_addresses';

function loadSavedAddresses() {
  try {
    const saved = JSON.parse(localStorage.getItem(ADDRESS_STORAGE_KEY) || '[]');
    saved.forEach(addr => {
      const opt = document.createElement('option');
      opt.value = addr;
      opt.textContent = addr;
      addressSelect.insertBefore(opt, addressSelect.lastElementChild);
    });
  } catch (e) { console.error(e); }
}

function saveAddress(addr) {
  try {
    const saved = JSON.parse(localStorage.getItem(ADDRESS_STORAGE_KEY) || '[]');
    if (!saved.includes(addr)) {
      saved.push(addr);
      localStorage.setItem(ADDRESS_STORAGE_KEY, JSON.stringify(saved));
    }
  } catch (e) { console.error(e); }
}

addressSelect.addEventListener('change', () => {
  if (addressSelect.value === '__custom__') {
    customAddressInput.style.display = 'block';
    customAddressInput.required = true;
    customAddressInput.focus();
  } else {
    customAddressInput.style.display = 'none';
    customAddressInput.required = false;
  }
});

customAddressInput.addEventListener('blur', () => {
  const value = customAddressInput.value.trim();
  if (!value) return;
  saveAddress(value);
  const opt = document.createElement('option');
  opt.value = value;
  opt.textContent = value;
  addressSelect.insertBefore(opt, addressSelect.lastElementChild);
  addressSelect.value = value;
  customAddressInput.value = '';
  customAddressInput.style.display = 'none';
});

function renderDynamicFields() {
  dynamicFields.innerHTML = '';
  if (typeEl.value === 'school' || typeEl.value === 'trip') {
    dynamicFields.innerHTML = '<label>Номер класса</label><input id="input1" maxlength="5"><label>Номер школы</label><input id="input2" maxlength="5">';
  } else if (typeEl.value === 'kindergarten') {
    dynamicFields.innerHTML = '<label>Воспитанник сада</label><input id="input1"><label>Группа</label><input id="input2" maxlength="5">';
  } else if (typeEl.value === 'corporate') {
    dynamicFields.innerHTML = '<label>Название мероприятия</label><input id="eventNameInput" placeholder="Новогодний корпоратив">';
  }
}

function applyTemplate() {
  const t = TEMPLATES[typeEl.value];
  if (!t) return;
  card.style.backgroundImage = 'url(' + t.bg + ')';
  
  const setPos = (el, cfg) => {
    if(!cfg) { el.style.opacity = 0; return; }
    el.style.top = cfg.top + 'px';
    el.style.left = cfg.left !== undefined ? cfg.left + 'px' : '';
  };

  setPos(inviteEl, t.invite);
  if(t.invite) inviteEl.style.fontSize = t.invite.size + 'px';
  setPos(addressField, t.address);
  setPos(dateField, t.date);
  setPos(timeField, t.time);
  setPos(field1, t.field1);
  setPos(field2, t.field2);
  setPos(eventNameField, t.eventName);
}

function updatePreview(name) {
  if (!typeEl.value) return;
  addressField.textContent = addressSelect.value;
  dateField.textContent = dateEl.value;
  timeField.textContent = timeEl.value;

  const input1 = document.getElementById('input1');
  const input2 = document.getElementById('input2');
  const eventNameInput = document.getElementById('eventNameInput');

  field1.textContent = input1?.value || '';
  field2.textContent = input2?.value || '';
  eventNameField.textContent = eventNameInput?.value || '';

  const fields = [addressField, dateField, timeField, field1, field2, eventNameField, inviteEl];
  fields.forEach(f => { if(f.textContent.trim()) f.style.opacity = 1; });

  if (!name) {
    const names = namesEl.value.split('\n').map(n => n.trim()).filter(Boolean);
    name = names[0] || 'Имя Гостя';
  }
  inviteEl.textContent = name;
}

typeEl.addEventListener('change', () => { renderDynamicFields(); applyTemplate(); updatePreview(''); });
document.getElementById('form').addEventListener('input', () => updatePreview(''));
loadSavedAddresses();

// --- ЛОГИКА СКАЧИВАНИЯ (CANVAS) ---

document.getElementById('download').addEventListener('click', async () => {
  const form = document.getElementById('form');
  if (!form.checkValidity()) { form.reportValidity(); return; }

  const names = namesEl.value.split('\n').map(n => n.trim()).filter(Boolean);
  const type = typeEl.value;
  const config = EXPORT_CONFIG[type] || EXPORT_CONFIG.kid;

  const canvas = document.createElement('canvas');
  canvas.width = EXPORT_CONFIG.canvasWidth;
  canvas.height = EXPORT_CONFIG.canvasHeight;
  const ctx = canvas.getContext('2d');

  const bgImg = new Image();
  bgImg.src = TEMPLATES[type].bg;
  await new Promise(res => bgImg.onload = res);

  const pdf = new jspdf.jsPDF({
    orientation: 'p', unit: 'px', format: [canvas.width, canvas.height],
    hotfixes: ['px_scaling']
  });

  // ВНУТРЕННЯЯ ФУНКЦИЯ ДЛЯ ПЕРЕНОСА ТЕКСТА
  const drawTextWrapped = (text, cfg, maxWidth, indentX) => {
    if (!text || !cfg) return;
    ctx.font = `600 ${cfg.size}px Montserrat`;
    ctx.textAlign = 'left';
    
    const words = text.split(' ');
    let line = '';
    let y = cfg.y;
    const lineHeight = cfg.size * 2; // Подобрал чуть меньше для компактности
    
    let isFirstLine = true;
    let currentX = cfg.x; // Начальная точка для первой строки

    for (let n = 0; n < words.length; n++) {
        let testLine = line + words[n] + ' ';
        let metrics = ctx.measureText(testLine);
        
        // Для первой строки maxWidth должен быть меньше, так как она начинается правее
        let currentMaxWidth = isFirstLine ? (maxWidth - (cfg.x - indentX)) : maxWidth;

        if (metrics.width > currentMaxWidth && n > 0) {
            ctx.fillText(line.trim(), currentX, y);
            
            // Настраиваем параметры для ПОСЛЕДУЮЩИХ строк
            line = words[n] + ' ';
            y += lineHeight;
            currentX = indentX; // Смещаем X влево
            isFirstLine = false;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line.trim(), currentX, y);
};

  const input1Value =
  document.getElementById('input1')?.value || '';

  const input2Value =
  document.getElementById('input2')?.value || '';

  const eventNameValue =
  document.getElementById('eventNameInput')?.value || '';


  for (let i = 0; i < names.length; i++) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#3a2518";
    ctx.textBaseline = "top";

    // Обычный текст (имя, дата, время)
    const drawText = (text, cfg) => {
      if (!text || !cfg) return;
      ctx.font = `600 ${cfg.size}px Montserrat`;
      ctx.textAlign = cfg.align || 'center';
      ctx.fillText(text, cfg.x, cfg.y);
    };

    drawText(names[i], config.invite);
    
    // АДРЕС С ПЕРЕНОСОМ (ширина 600 пикселей, подберите под макет)
    drawTextWrapped(addressSelect.value, config.address, 800, 130);
    
   

drawText(dateEl.value, config.date);
drawText(timeEl.value, config.time);
drawText(input1Value, config.field1);
drawText(input2Value, config.field2);
drawText(eventNameValue, config.eventName);

   
    
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    if (i > 0) pdf.addPage([canvas.width, canvas.height]);
    pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height);
  }

  pdf.save('invites_fort.pdf');
});
</script>

</body>
</html>
